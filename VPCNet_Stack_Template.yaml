Description:  NovusNet AWS-GovCloud template stack.
# Replace PrivateSubnet1Name with your desired name
# Repeat for all other PrivateSubnets 2,3,4
# Replace PublicSubnet1Name with your desired name

Parameters:
  EnvironmentName:
    Description: An environment name that is prefixed to resource names
    Type: String
    Default: NovusNet

  VpcCIDR:
    Description: Please enter the IP range (CIDR notation) for this VPC
    Type: String
    Default: 10.0.0.0/16

  PublicSubnet1NameSubnetCIDR:
    Description: Please enter the IP range (CIDR notation) for the PublicSubnet1Name Subnet (Public)
    Type: String
    Default: 10.0.0.0/24

  PrivateSubnet1NameSubnetCIDR:
    Description: Please enter the IP range (CIDR notation) for the NI Team Subnet (Private)
    Type: String
    Default: 10.0.1.0/24

  PrivateSubnet2NameSubnetCIDR:
    Description: Please enter the IP range (CIDR notation) for the PrivateSubnet2Name Team Subnet (Private)
    Type: String
    Default: 10.0.2.0/24

  SubnetCIDR:
    Description: Please enter the IP range (CIDR notation) for the PrivateSubnet3Name. Subnet (Private)
    Type: String
    Default: 10.0.3.0/24
  
  PrivateSubnet4NameSubnetCIDR:
    Description: Please enter the IP range (CIDR notation) for the PrivateSubnet4Name Subnet (Private)
    Type: String
    Default: 10.0.4.0/24

Resources:
# General VPC/Network Configuration:
# VPC Configuration
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} VPC

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} Internet Gateway

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} NAT Gateway EIP

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref InternetSubnet
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} NAT Gateway
  
# Route Tables    
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} Public Routes

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} Private Routes

  DefaultPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway
  
# Route Table Associations
  PublicSubnet1NameSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1NameSubnet
  
  PrivateSubnet1NameSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet1NameSubnet

  PrivateSubnet2NameSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet2NameSubnet
 
  PrivateSubnet3NameSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet3NameSubnet

  PrivateSubnet4NameSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet4NameSubnet

# Subnet Defintions
  PublicSubnet1NameSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      CidrBlock: !Ref PublicSubnet1NameSubnetCIDR
      MapPublicIpOnLaunch: true
      Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName} PublicSubnet1Name Subnet
  
  PrivateSubnet1NameSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [ 0, !GetAZs  '' ]
      CidrBlock: !Ref PrivateSubnet1NameSubnetCIDR
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} NI Team Subnet
  
  PrivateSubnet2NameSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [ 0, !GetAZs  '' ]
      CidrBlock: !Ref PrivateSubnet2NameSubnetCIDR
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} PrivateSubnet2Name Subnet
  
  PrivateSubnet3NameSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [ 0, !GetAZs  '' ]
      CidrBlock: !Ref PrivateSubnet3NameSubnetCIDR
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} PrivateSubnet3Name. Subnet

  PrivateSubnet4NameSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [ 0, !GetAZs  '' ]
      CidrBlock: !Ref PrivateSubnet4NameSubnetCIDR
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} PrivateSubnet4Name Subnet

# Network Access Control Lists (NACLs):
# NI Team Subnet NACLs
  PrivateSubnet1NameSubnetNACL:
    Type: AWS::EC2::NetworkAcl
    Properties:
       VpcId: !Ref VPC
       Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} NI Team Subnet NACL
  
  PrivateSubnet1NameSubnetNACLAssociation:
    Type: 'AWS::EC2::SubnetNetworkAclAssociation'
    Properties:
      NetworkAclId: !Ref PrivateSubnet1NameSubnetNACL
      SubnetId: !Ref PrivateSubnet1NameSubnet

  # Inbound
  PrivateSubnet1NameSubnetInboundNACLEntry1:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet1NameSubnetNACL
        RuleNumber: 100
        Protocol: -1
        RuleAction: Deny
        Egress: false
        CidrBlock: !Ref PrivateSubnet2NameSubnetCIDR

  PrivateSubnet1NameSubnetInboundNACLEntry2:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet1NameSubnetNACL
        RuleNumber: 101
        Protocol: -1
        RuleAction: Deny
        Egress: false
        CidrBlock: !Ref PrivateSubnet3NameSubnetCIDR

  PrivateSubnet1NameSubnetInboundNACLEntry3:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet1NameSubnetNACL
        RuleNumber: 999
        Protocol: -1
        RuleAction: Allow
        Egress: false
        CidrBlock: 0.0.0.0/0

  # Outbound
  PrivateSubnet1NameSubnetOutboundNACLEntry1:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet1NameSubnetNACL
        RuleNumber: 100
        Protocol: -1
        RuleAction: deny
        Egress: true
        CidrBlock: !Ref PrivateSubnet2NameSubnetCIDR

  PrivateSubnet1NameSubnetOutboundNACLEntry2:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet1NameSubnetNACL
        RuleNumber: 101
        Protocol: -1
        RuleAction: deny
        Egress: true
        CidrBlock: !Ref PrivateSubnet3NameSubnetCIDR

  PrivateSubnet1NameSubnetOutboundNACLEntry3:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet1NameSubnetNACL
        RuleNumber: 999
        Protocol: -1
        RuleAction: allow
        Egress: true
        CidrBlock: 0.0.0.0/0
  # End of NI Team Subnet NACLs

# Novus Labs Subnet NACLs
  PrivateSubnet2NameSubnetNACL:
    Type: AWS::EC2::NetworkAcl
    Properties:
       VpcId: !Ref VPC
       Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} Novus Labs Subnet NACL
  
  PrivateSubnet2NameSubnetNACLAssociation:
    Type: 'AWS::EC2::SubnetNetworkAclAssociation'
    Properties:
      NetworkAclId: !Ref PrivateSubnet2NameSubnetNACL
      SubnetId: !Ref PrivateSubnet2NameSubnet

  # Inbound
  PrivateSubnet2NameSubnetInboundNACLEntry1:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet2NameSubnetNACL
        RuleNumber: 100
        Protocol: -1
        RuleAction: Deny
        Egress: false
        CidrBlock: !Ref PrivateSubnet1NameSubnetCIDR

  PrivateSubnet2NameSubnetInboundNACLEntry2:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet2NameSubnetNACL
        RuleNumber: 101
        Protocol: -1
        RuleAction: Deny
        Egress: false
        CidrBlock: !Ref PrivateSubnet3NameSubnetCIDR

  PrivateSubnet2NameSubnetInboundNACLEntry3:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet2NameSubnetNACL
        RuleNumber: 999
        Protocol: -1
        RuleAction: Allow
        Egress: false
        CidrBlock: 0.0.0.0/0

  # Outbound
  PrivateSubnet2NameSubnetOutboundNACLEntry1:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet2NameSubnetNACL
        RuleNumber: 100
        Protocol: -1
        RuleAction: deny
        Egress: true
        CidrBlock: !Ref PrivateSubnet1NameSubnetCIDR

  PrivateSubnet2NameSubnetOutboundNACLEntry2:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet2NameSubnetNACL
        RuleNumber: 101
        Protocol: -1
        RuleAction: deny
        Egress: true
        CidrBlock: !Ref PrivateSubnet3NameSubnetCIDR

  PrivateSubnet2NameSubnetOutboundNACLEntry3:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet2NameSubnetNACL
        RuleNumber: 999
        Protocol: -1
        RuleAction: allow
        Egress: true
        CidrBlock: 0.0.0.0/0
  # End of Novus Labs Subnet NACLs

# PrivateSubnet3Name Subnet NACLs
  PrivateSubnet3NameSubnetNACL:
    Type: AWS::EC2::NetworkAcl
    Properties:
       VpcId: !Ref VPC
       Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} PrivateSubnet3Name Subnet NACL
  
  PrivateSubnet3NameSubnetNACLAssociation:
    Type: 'AWS::EC2::SubnetNetworkAclAssociation'
    Properties:
      NetworkAclId: !Ref PrivateSubnet3NameSubnetNACL
      SubnetId: !Ref PrivateSubnet3NameSubnet

  # Inbound
  PrivateSubnet3NameSubnetInboundNACLEntry1:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet3NameSubnetNACL
        RuleNumber: 100
        Protocol: -1
        RuleAction: Deny
        Egress: false
        CidrBlock: !Ref PrivateSubnet1NameSubnetCIDR

  PrivateSubnet3NameSubnetInboundNACLEntry2:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet3NameSubnetNACL
        RuleNumber: 101
        Protocol: -1
        RuleAction: Deny
        Egress: false
        CidrBlock: !Ref PrivateSubnet2NameSubnetCIDR

  PrivateSubnet3NameSubnetInboundNACLEntry3:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet3NameSubnetNACL
        RuleNumber: 999
        Protocol: -1
        RuleAction: Allow
        Egress: false
        CidrBlock: 0.0.0.0/0

  # Outbound
  PrivateSubnet3NameSubnetOutboundNACLEntry1:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet3NameSubnetNACL
        RuleNumber: 100
        Protocol: -1
        RuleAction: deny
        Egress: true
        CidrBlock: !Ref PrivateSubnet1NameSubnetCIDR

  PrivateSubnet3NameSubnetOutboundNACLEntry2:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet3NameSubnetNACL
        RuleNumber: 101
        Protocol: -1
        RuleAction: deny
        Egress: true
        CidrBlock: !Ref PrivateSubnet2NameSubnetCIDR

  PrivateSubnet3NameSubnetOutboundNACLEntry3:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
        NetworkAclId: !Ref PrivateSubnet3NameSubnetNACL
        RuleNumber: 999
        Protocol: -1
        RuleAction: allow
        Egress: true
        CidrBlock: 0.0.0.0/0
  # End of PrivateSubnet3Name Subnet NACLs


# Security Groups:
# PublicSubnet1Name Security Groups
  PublicSubnet1NameSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
        GroupDescription: PublicSubnet1Name Security Group
        GroupName: !Sub ${EnvironmentName} PublicSubnet1Name Security Group
        VpcId: !Ref VPC
        Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} PublicSubnet1Name Security Group
        SecurityGroupIngress:
        # Allowing HTTP anywhere
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        # Allowing HTTPS anywhere
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        # Allowing SSH from the VPC Subnet
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref VpcCIDR
        # Allowing SSH from the WireGuard Subnet
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 10.0.0.0/8
        # Allowing RDP from the VPC Subnet
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref VpcCIDR
        # Allowing UDP 23917 anywhere (Wireguard)
        - IpProtocol: udp
          FromPort: 23917
          ToPort: 23917
          CidrIp: 0.0.0.0/0
        # Allow ICMP from the VPC Subnet
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !Ref VpcCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.0.0.0/8
        # Allowing SSH on Wireguard backup port
        - IpProtocol: tcp
          FromPort: 8722
          ToPort: 8722
          CidrIp: 0.0.0.0/0
        # Above rules are reflected below as well
        SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref VpcCIDR
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 10.0.0.0/8
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref VpcCIDR
        - IpProtocol: udp
          FromPort: 23917
          ToPort: 23917
          CidrIp: 0.0.0.0/0
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !Ref VpcCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.0.0.0/8
        - IpProtocol: tcp
          FromPort: 8722
          ToPort: 8722
          CidrIp: 0.0.0.0/0

# PrivateSubnet4Name Security Groups
  PrivateSubnet4NameSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
        GroupDescription: PrivateSubnet4Name Security Group
        GroupName: !Sub ${EnvironmentName} PrivateSubnet4Name Security Group
        VpcId: !Ref VPC
        Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} PrivateSubnet4Name Security Group
        SecurityGroupIngress:
        # Allowing HTTP anywhere
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        # Allowing HTTPS anywhere
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        # Allowing SSH from the VPC Subnet
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref VpcCIDR
        # Allowing SSH from the WireGuard Subnet
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 10.0.0.0/8
        # Allowing RDP from the VPC Subnet
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref VpcCIDR
        # Allow ICMP from the VPC Subnet
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !Ref VpcCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.0.0.0/8
        # Above rules are reflected below as well
        SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref VpcCIDR
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 10.0.0.0/8
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref VpcCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !Ref VpcCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.0.0.0/8

# NI Team Security Groups
  PrivateSubnet1NameSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
        GroupDescription: NI Team Security Group
        GroupName: !Sub ${EnvironmentName} NI Team Security Group
        VpcId: !Ref VPC
        Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} NI Team Security Group
        SecurityGroupIngress:
        # Allowing HTTP anywhere
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        # Allowing HTTPS anywhere
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        # Allowing ALL for NI Team Subnet
        - IpProtocol: -1
          CidrIp: !Ref PrivateSubnet1NameSubnetCIDR
        # Allowing SSH for PublicSubnet1Name Subnet
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref PublicSubnet1NameSubnetCIDR
        # Allowing RDP for PublicSubnet1Name Subnet
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref PublicSubnet1NameSubnetCIDR
        # Allowing SSH for PrivateSubnet4Name Subnet
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref PrivateSubnet4NameSubnetCIDR
        # Allowing RDP for PublicSubnet1Name Subnet
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref PrivateSubnet4NameSubnetCIDR
        # Allow ICMP from the VPC Subnet
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !Ref VpcCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.0.0.0/8
        # Above rules are reflected below as well
        SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: -1
          CidrIp: !Ref PrivateSubnet1NameSubnetCIDR
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref PublicSubnet1NameSubnetCIDR
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref PublicSubnet1NameSubnetCIDR
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref PrivateSubnet4NameSubnetCIDR
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref PrivateSubnet4NameSubnetCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !Ref VpcCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.0.0.0/8

# Novus Labs Security Group
  PrivateSubnet2NameSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
        GroupDescription: Novus Labs Security Group
        GroupName: !Sub ${EnvironmentName} Novus Labs Security Group
        VpcId: !Ref VPC
        Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} Novus Labs Security Group
        SecurityGroupIngress:
        # Allowing HTTP anywhere
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        # Allowing HTTPS anywhere
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        # Allowing ALL for Novus Labs Subnet
        - IpProtocol: -1
          CidrIp: !Ref PrivateSubnet2NameSubnetCIDR
        # Allowing SSH for PublicSubnet1Name Subnet
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref PublicSubnet1NameSubnetCIDR
        # Allowing RDP for PublicSubnet1Name Subnet
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref PublicSubnet1NameSubnetCIDR
        # Allowing SSH for PrivateSubnet4Name Subnet
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref PrivateSubnet4NameSubnetCIDR
        # Allowing RDP for PublicSubnet1Name Subnet
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref PrivateSubnet4NameSubnetCIDR
        # Allow ICMP from the VPC Subnet
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !Ref VpcCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.0.0.0/8
        # Above rules are reflected below as well
        SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: -1
          CidrIp: !Ref PrivateSubnet2NameSubnetCIDR
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref PublicSubnet1NameSubnetCIDR
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref PublicSubnet1NameSubnetCIDR
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref PrivateSubnet4NameSubnetCIDR
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref PrivateSubnet4NameSubnetCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !Ref VpcCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.0.0.0/8

# PrivateSubnet3Name Security Group
  PrivateSubnet3NameSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
        GroupDescription: PrivateSubnet3Name Security Group
        GroupName: !Sub ${EnvironmentName} PrivateSubnet3Name Security Group
        VpcId: !Ref VPC
        Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} PrivateSubnet3Name Security Group
        SecurityGroupIngress:
        # Allowing HTTP anywhere
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        # Allowing HTTPS anywhere
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        # Allowing ALL for PrivateSubnet3Name Subnet
        - IpProtocol: -1
          CidrIp: !Ref PrivateSubnet3NameSubnetCIDR
        # Allowing SSH for PublicSubnet1Name Subnet
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref PublicSubnet1NameSubnetCIDR
        # Allowing RDP for PublicSubnet1Name Subnet
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref PublicSubnet1NameSubnetCIDR
        # Allowing SSH for PrivateSubnet4Name Subnet
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref PrivateSubnet4NameSubnetCIDR
        # Allowing RDP for PublicSubnet1Name Subnet
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref PrivateSubnet4NameSubnetCIDR
        # Allow ICMP from the VPC Subnet
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !Ref VpcCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.0.0.0/8
        # Above rules are reflected below as well
        SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: -1
          CidrIp: !Ref PrivateSubnet3NameSubnetCIDR
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref PublicSubnet1NameSubnetCIDR
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref PublicSubnet1NameSubnetCIDR
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref PrivateSubnet4NameSubnetCIDR
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref PrivateSubnet4NameSubnetCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !Ref VpcCIDR
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.0.0.0/8

#Additional Network Configurations:
# S2S VPN Configuration
  VPNCustomerGateway:
    Type: AWS::EC2::CustomerGateway
    Properties:
      Type: ipsec.1
      BgpAsn: 65000
      IpAddress: 50.242.213.253
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} VPN Customer Gateway

  VPNGateway:
    Type: AWS::EC2::VPNGateway
    Properties:
      Type: ipsec.1
      Tags: 
        - Key: Name
          Value: !Sub ${EnvironmentName} VPN Gateway

  VPNGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
        VpnGatewayId: !Ref VPNGateway
        VpcId: !Ref VPC

Outputs:
  VPC:
    Description: A reference to the created VPC
    Value: !Ref VPC

  PublicSubnets:
    Description: A list of the public subnets
    Value: !Ref PublicSubnet1NameSubnet

  PrivateSubnets:
    Description: A list of the private subnets
    Value: !Join [ ",", [ !Ref PrivateSubnet1NameSubnet, !Ref PrivateSubnet2NameSubnet, !Ref PrivateSubnet4NameSubnet, !Ref PrivateSubnet3NameSubnet]]

  PublicSubnet1NameSubnet:
    Description: A reference to the PublicSubnet1Name Subnet
    Value: !Ref PublicSubnet1NameSubnet

  PrivateSubnet1NameSubnet:
    Description: A reference to the NI Team Subnet
    Value: !Ref PrivateSubnet1NameSubnet

  PrivateSubnet2NameSubnet:
    Description: A reference to the PrivateSubnet2Name Subnet
    Value: !Ref PrivateSubnet2NameSubnet

  PrivateSubnet3NameSubnet:
    Description: A reference to the PrivateSubnet3Name. Subnet
    Value: !Ref PrivateSubnet3NameSubnet
  
  PrivateSubnet4NameSubnet:
    Description: A reference to the PrivateSubnet4Name Subnet
    Value: !Ref PrivateSubnet4NameSubnet
